// Generated by CoffeeScript 1.6.3
var app, contributor, error, express, _;

_ = require('lodash');

contributor = require('./contributor');

express = require('express');

app = express();

app.use(express.logger());

error = function(res, code, message) {
  return res.send(code, {
    status: code,
    message: message || ''
  });
};

app.get('/api', function(req, res) {
  var err, identities, param, platform, success, _i, _len, _ref;
  if (!(_.keys(req.query)).length) {
    error(res, 400, 'Error: API requires one or more identities passed as query parameters');
  }
  identities = {};
  success = function(counts) {
    return res.send(counts);
  };
  err = function(e) {
    return error(res, 404, e);
  };
  _ref = contributor.support;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    platform = _ref[_i];
    param = req.query[platform];
    if (param) {
      identities[platform] = param;
    }
  }
  return contributor(identities).then(success, err);
});

exports.app = app;
